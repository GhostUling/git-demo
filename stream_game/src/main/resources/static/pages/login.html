<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>登录/注册 - Stream</title>
		<link rel="stylesheet" href="style.css">
		<style>
			.login-container {
				max-width: 400px;
				margin: 100px auto;
				background: #1e2837;
				border-radius: 8px;
				padding: 30px;
				box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
			}
			
			.login-title {
				text-align: center;
				margin-bottom: 30px;
				color: #fff;
			}
			
			.form-group {
				margin-bottom: 20px;
			}
			
			.form-label {
				display: block;
				margin-bottom: 8px;
				color: #c6d4df;
				font-size: 14px;
			}
			
			.form-input {
				width: 100%;
				padding: 12px;
				background: #32404e;
				border: 1px solid #465b70;
				border-radius: 4px;
				color: #fff;
				font-size: 14px;
				transition: all 0.3s ease;
			}
			
			.form-input:focus {
				outline: none;
				border-color: #66c0f4;
				box-shadow: 0 0 0 2px rgba(102, 192, 244, 0.2);
			}
			
			.login-btn {
				width: 100%;
				padding: 12px;
				background: #66c0f4;
				color: #fff;
				border: none;
				border-radius: 4px;
				font-size: 16px;
				font-weight: bold;
				cursor: pointer;
				transition: all 0.3s ease;
			}
			
			.login-btn:hover {
				background: #4f9cbd;
			}
			
			.login-links {
				margin-top: 20px;
				text-align: center;
				font-size: 14px;
			}
			
			.login-links a {
				color: #66c0f4;
				text-decoration: none;
			}
			
			.login-links a:hover {
				text-decoration: underline;
			}
			
			.login-switch {
				text-align: center;
				margin-top: 15px;
			}
			
			.login-switch a {
				color: #66c0f4;
				text-decoration: none;
				cursor: pointer;
			}
			
			.register-form {
				display: none;
			}
		</style>
	</head>
	<body>
		<nav class="navbar">
			<div class="nav-content">
				<!-- 左侧logo -->
				<a href="index.html" class="logo">Stream</a>
				
				<!-- 搜索框 -->
				<div class="search-container">
					<form id="search-form">
						<input type="text" 
							   placeholder="搜索游戏..." 
							   class="search-input"
							   id="search-input">
						<button type="submit" class="search-btn">
							<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#b8b6b4" stroke-width="2">
								<circle cx="11" cy="11" r="8"/>
								<path d="M21 21l-4.35-4.35"/>
							</svg>
						</button>
					</form>
				</div>
	
				<!-- 右侧导航链接 -->
				<div class="nav-links">
					<a href="index.html">商城</a>
					<a href="cart.html">购物车 <span class="cart-counter">0</span></a>
					<a href="profile.html">个人中心</a>
					<a href="login.html">登录/注册</a>
					<a href="PushGame.html">发布游戏</a>
					<a href="about.html">关于</a>
				</div>
			</div>
		</nav>

		<div class="container">
			<div class="login-container">
				<!-- 登录表单 -->
				<div class="login-form" id="login-form-container">
					<h2 class="login-title">登录账户</h2>
					<form id="login-form">
						<div class="form-group">
							<label for="username" class="form-label">用户名</label>
							<input type="text" id="username" class="form-input" placeholder="请输入用户名" required>
						</div>
						<div class="form-group">
							<label for="password" class="form-label">密码</label>
							<input type="password" id="password" class="form-input" placeholder="请输入密码" required>
						</div>
						<button type="submit" class="login-btn">登录</button>
					</form>
					<div class="login-links">
						<a href="#">忘记密码?</a>
					</div>
					<div class="login-switch">
						没有账户? <a id="show-register">点击注册</a>
					</div>
				</div>
				
				<!-- 注册表单 -->
				<div class="register-form" id="register-form-container">
					<h2 class="login-title">创建账户</h2>
					<div class="reg-guide">
						<p style="color: #9cbcce; font-size: 13px; margin-bottom: 20px; text-align: center;">
							注册流程：1.输入信息 → 2.发送验证码 → 3.验证邮箱 → 4.完成注册
						</p>
					</div>
					<form id="register-form">
						<div class="form-group">
							<label for="reg-username" class="form-label">用户名</label>
							<input type="text" id="reg-username" class="form-input" placeholder="请输入用户名" required>
						</div>
						<div class="form-group">
							<label for="reg-email" class="form-label">电子邮箱</label>
							<input type="email" id="reg-email" class="form-input" placeholder="请输入电子邮箱" required>
						</div>
						<div class="form-group verification-code-group">
							<label for="reg-verification-code" class="form-label">验证码</label>
							<div style="display: flex; gap: 10px;">
								<input type="text" id="reg-verification-code" class="form-input" style="flex: 1;" placeholder="请输入验证码" required>
								<button type="button" id="send-code-btn" class="login-btn" style="width: 120px;">发送验证码</button>
							</div>
							<span style="color: #66c0f4; font-size: 12px; margin-top: 5px; display: block;">
								验证码将发送至您的邮箱，15分钟内有效
							</span>
							<div id="verification-status" style="color: #66c0f4; font-size: 12px; margin-top: 5px; display: none;"></div>
						</div>
						<div class="form-group">
							<label for="reg-password" class="form-label">密码</label>
							<input type="password" id="reg-password" class="form-input" placeholder="请输入密码" required>
						</div>
						<div class="form-group">
							<label for="reg-confirm-password" class="form-label">确认密码</label>
							<input type="password" id="reg-confirm-password" class="form-input" placeholder="请再次输入密码" required>
						</div>
						<div class="form-group" style="margin-top: 15px;">
							<div style="display: flex; align-items: center;">
								<input type="checkbox" id="agreement" required style="margin-right: 10px;">
								<label for="agreement" style="color: #9cbcce; font-size: 13px;">
									我已阅读并同意 <a href="#" style="color: #66c0f4; text-decoration: none;">用户协议</a> 和 <a href="#" style="color: #66c0f4; text-decoration: none;">隐私政策</a>
								</label>
							</div>
						</div>
						<button type="submit" class="login-btn">注册</button>
					</form>
					<div class="login-switch">
						已有账户? <a id="show-login">点击登录</a>
					</div>
				</div>
			</div>
		</div>

		<footer>
			<div class="footer-content">
				<div class="footer-section">
					<h4>关于我们</h4>
					<a href="#">制作人员名单</a>
				</div>
				<div class="footer-section">
					<h4>客户服务</h4>
					<a href="#">帮助中心</a>
					<a href="#">常见问题</a>
				</div>
				<div class="footer-section">
					<h4>法律条款</h4>
					<a href="#">隐私政策</a>
					<a href="#">用户协议</a>
				</div>
				<div class="footer-section">
					<h4>关注我们</h4>
					<a href="images/qq.jpg">QQ</a>
					<a href="images/weixin.jpg">微信</a>
					<a href="#">GitHub</a>
				</div>
			</div>
		</footer>

		<script src="main.js"></script>
		<script>
			// 登录/注册表单切换
			document.addEventListener('DOMContentLoaded', function() {
				const showRegister = document.getElementById('show-register');
				const showLogin = document.getElementById('show-login');
				const loginFormContainer = document.getElementById('login-form-container');
				const registerFormContainer = document.getElementById('register-form-container');
				
				if (showRegister && showLogin) {
					showRegister.addEventListener('click', function() {
						loginFormContainer.style.display = 'none';
						registerFormContainer.style.display = 'block';
					});
					
					showLogin.addEventListener('click', function() {
						registerFormContainer.style.display = 'none';
						loginFormContainer.style.display = 'block';
					});
				}
				
				// 登录表单提交
				const loginForm = document.getElementById('login-form');
				if (loginForm) {
					loginForm.addEventListener('submit', function(e) {
						e.preventDefault();
						
						const username = document.getElementById('username').value;
						const password = document.getElementById('password').value;
						
						fetch('http://localhost:8080/api/players/login', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								username: username,
								password: password
							})
						})
						.then(response => {
							if (response.status === 401) {
								throw new Error('用户名或密码错误');
							}
							if (!response.ok) {
								throw new Error('登录失败');
							}
							return response.json();
						})
						.then(player => {
							alert('登录成功！欢迎 ' + player.username);
							// 保存登录状态
							localStorage.setItem('currentPlayer', JSON.stringify(player));
							// 跳转至首页
							window.location.href = 'index.html';
						})
						.catch(error => {
							alert(error.message);
						});
					});
				}
				
				// 注册表单提交
				const registerForm = document.getElementById('register-form');
				const sendCodeBtn = document.getElementById('send-code-btn');
				
				if (sendCodeBtn) {
					sendCodeBtn.addEventListener('click', function() {
						const email = document.getElementById('reg-email').value;
						if (!email) {
							alert('请输入邮箱地址');
							return;
						}
						
						// 验证邮箱格式
						const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
						if (!emailRegex.test(email)) {
							alert('请输入有效的邮箱地址');
							return;
						}
						
						// 禁用按钮，防止重复发送
						sendCodeBtn.disabled = true;
						sendCodeBtn.textContent = '发送中...';
						
						fetch('http://localhost:8080/api/email-verification/send-code', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								email: email
							})
						})
						.then(response => {
							if (!response.ok) {
								if (response.status === 409) {
									throw new Error('该邮箱已被注册');
								}
								throw new Error('发送验证码失败');
							}
							return response.json();
						})
						.then(data => {
							alert('验证码已发送到您的邮箱，请查收');
							console.log('验证码发送响应:', data);
							
							// 显示验证码状态
							const statusDiv = document.getElementById('verification-status');
							statusDiv.textContent = '验证码已发送，请查收邮箱';
							statusDiv.style.display = 'block';
							
							// 倒计时60秒后重新启用按钮
							let countdown = 60;
							const timer = setInterval(() => {
								countdown--;
								sendCodeBtn.textContent = `${countdown}秒后重发`;
								if (countdown <= 0) {
									clearInterval(timer);
									sendCodeBtn.disabled = false;
									sendCodeBtn.textContent = '发送验证码';
								}
							}, 1000);
						})
						.catch(error => {
							alert(error.message);
							sendCodeBtn.disabled = false;
							sendCodeBtn.textContent = '发送验证码';
						});
					});
				}
				
				if (registerForm) {
					registerForm.addEventListener('submit', function(e) {
						e.preventDefault();
						
						const username = document.getElementById('reg-username').value;
						const email = document.getElementById('reg-email').value;
						const verificationCode = document.getElementById('reg-verification-code').value;
						const password = document.getElementById('reg-password').value;
						const confirmPassword = document.getElementById('reg-confirm-password').value;
						const agreement = document.getElementById('agreement').checked;
						
						// 检查用户协议是否同意
						if (!agreement) {
							alert('请阅读并同意用户协议和隐私政策');
							return;
						}
						
						// 验证用户名格式
						if (username.length < 3 || username.length > 20) {
							alert('用户名长度应在3-20个字符之间');
							return;
						}
						
						// 验证邮箱格式
						const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
						if (!emailRegex.test(email)) {
							alert('请输入有效的邮箱地址');
							return;
						}
						
						// 验证密码强度
						if (password.length < 6) {
							alert('密码长度至少为6个字符');
							return;
						}
						
						if (password !== confirmPassword) {
							alert('两次输入的密码不一致');
							return;
						}
						
						if (!verificationCode) {
							alert('请输入验证码');
							return;
						}
						
						// 显示加载状态
						const submitButton = registerForm.querySelector('button[type="submit"]');
						const originalText = submitButton.textContent;
						submitButton.disabled = true;
						submitButton.textContent = '处理中...';
						
						// 先验证验证码
						fetch('http://localhost:8080/api/email-verification/verify', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								email: email,
								code: verificationCode
							})
						})
						.then(response => {
							if (!response.ok) {
								throw new Error('验证码验证失败');
							}
							return response.json();
						})
						.then(data => {
							console.log('验证码验证响应:', data);
							if (!data.verified) {
								throw new Error('验证码无效或已过期');
							}
							
							// 验证码验证成功，继续注册
							console.log('验证成功，开始注册用户...');
							return fetch('http://localhost:8080/api/players/register', {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify({
									username: username,
									email: email,
									password: password,
									verificationCode: verificationCode
								})
							});
						})
						.then(response => {
							// 检查是否是第二个fetch的响应
							if (!(response instanceof Response)) {
								return response; // 这是第一个fetch的结果，直接传递给下一个then
							}
							
							console.log('注册请求响应状态:', response.status);
							if (response.status === 409) {
								throw new Error('用户名或邮箱已存在');
							}
							if (response.status === 401) {
								throw new Error('验证码验证失败');
							}
							if (!response.ok) {
								response.text().then(text => {
									console.error('注册失败详情:', text);
								});
								throw new Error('注册失败');
							}
							return response.json();
						})
						.then(player => {
							// 确保这是一个Player对象
							if (!player || !player.username) {
								// 可能是第一个fetch的结果，不是player对象
								throw new Error('注册过程出错，请重试');
							}
							
							alert('注册成功，请登录');
							// 切换到登录表单
							registerFormContainer.style.display = 'none';
							loginFormContainer.style.display = 'block';
							// 自动填充用户名
							document.getElementById('username').value = username;
						})
						.catch(error => {
							console.error('注册流程错误:', error);
							alert(error.message);
						})
						.finally(() => {
							// 恢复按钮状态
							submitButton.disabled = false;
							submitButton.textContent = originalText;
						});
					});
				}
			});
		</script>
	</body>
</html> 